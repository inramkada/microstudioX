<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>microlabsX</title>

<!-- SEO  -->
<meta name="description" content="Global automation systems for institutional biotech infrastructure and strategic protein production " />
<meta property="og:title" content="microlabsX" />
<meta property="og:description" content="Automation-first infrastructure for institutional deployments and strategic protein production." />
<meta property="og:type" content="website" />

<style>
  html, body{
    margin:0; height:100%;
    background:#000; color:#fff;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    overflow:hidden; /* no scroll */
  }

  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{
      animation-duration:0.01ms !important;
      animation-iteration-count:1 !important;
      transition-duration:0.01ms !important;
      scroll-behavior:auto !important;
    }
    #bg{ opacity:.35; }
    .about-track{ scroll-behavior:auto !important; }
  }

  /* ===== Background video + fallback ===== */
  .bg-fallback{
    position:fixed; inset:0;
    z-index:0;
    background:#000;
  }
  .bg-fallback::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 700px at 70% 25%, rgba(255,255,255,.06), transparent 55%),
      radial-gradient(900px 500px at 25% 70%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.65));
  }

  #bg{
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
    background:#000;
  }

  /* ===== Topbar ===== */
  .topbar{
    position:fixed;
    top:18px; right:18px;
    z-index:9999;
    display:flex;
    align-items:center;
    gap:18px;
    mix-blend-mode:difference;
    user-select:none;
    -webkit-user-select:none;
  }
  .toplink{
    font-size:22px;
    font-weight:700;
    letter-spacing:.22em;
    text-transform:uppercase;
    white-space:nowrap;
    cursor:pointer;
    color:rgba(255,255,255,.92);
  }
  .toplink.muted{ color:rgba(255,255,255,.72); }

  /* ===== LANG globe (click-to-open) ===== */
  .lang{
    position:relative;
    display:flex;
    align-items:center;
  }
  .lang-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    width:28px;
    height:28px;
    border-radius:999px;
    cursor:pointer;
    color:rgba(255,255,255,.90);
  }
  .lang-btn svg{ width:18px; height:18px; opacity:.9; }

  /* LTR default: opens to the LEFT */
  .lang-row{
    position:absolute;
    right:100%;
    top:50%;
    transform:translateY(-50%) translateX(-14px);
    display:flex;
    align-items:center;
    gap:18px;
    opacity:0;
    pointer-events:none;
    white-space:nowrap;
  }
  .lang.is-open .lang-row{
    opacity:1;
    pointer-events:auto;
  }
  .lang-chip{
    font-size:15px;
    font-weight:700;
    letter-spacing:.22em;
    text-transform:uppercase;
    opacity:.72;
    cursor:pointer;
  }
  .lang-chip:hover{
    opacity:.95;
    text-decoration:underline;
    text-underline-offset:7px;
    text-decoration-thickness:2px;
  }

  /* ===== Nodes dropdown ===== */
  .nodes{ position:relative; cursor:default; }
  .nodes-bridge{
    position:absolute; top:100%;
    left:-30px; right:-30px;
    height:28px;
    background:transparent;
    pointer-events:auto;
  }
  .nodes-stack{
    position:absolute;
    top:calc(100% + 18px);
    left:50%;
    transform:translateX(-50%);
    display:grid;
    gap:22px;
    opacity:0;
    pointer-events:none;
    z-index:99999;
  }
  .nodes:hover .nodes-stack{
    opacity:1;
    pointer-events:auto;
  }
  .node{
    width:11.5ch;
    text-align:center;
    font-size:40px;
    font-weight:700;
    letter-spacing:.04em;
    opacity:.92;
    cursor:pointer;
    position:relative;
  }
  .node::after{
    content:"";
    position:absolute;
    left:50%;
    bottom:-12px;
    width:0;
    height:2px;
    transform:translateX(-50%);
    background: rgba(255,255,255,.9);
    opacity:.85;
  }
  .node:hover::after{ width:66%; }

  /* ===== Footer ===== */
  .index-footer{
    position:fixed;
    left:0; right:0;
    bottom:18px;
    z-index:9998;
    text-align:center;
    font-size:11px;
    letter-spacing:.14em;
    text-transform:uppercase;
    opacity:.60;
    mix-blend-mode:difference;
    padding:0 18px;
    pointer-events:auto;
    user-select:none;
    -webkit-user-select:none;
  }
  .index-footer a{
    color:rgba(255,255,255,.92);
    text-decoration:none;
    border-bottom:1px solid rgba(255,255,255,.28);
    padding-bottom:2px;
  }
  .index-footer a:hover{
    border-bottom-color:rgba(255,255,255,.75);
  }

  /* ===== SOUND FAB ===== */
  .sound-fab{
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:9999;
    display:flex;
    align-items:center;
    gap:14px;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
    mix-blend-mode:difference;
    color:rgba(255,255,255,.95);
    transform:translateZ(0);
    pointer-events:auto;
  }
  .sound-ico{
    width:40px;
    height:40px;
    opacity:.98;
    transform-origin: 50% 50%;
  }
  .sound-off{ display:none; }
  .sound-fab.is-muted .sound-on{ display:none; }
  .sound-fab.is-muted .sound-off{ display:block; }

  .sound-label{
    font-size:12px;
    font-weight:700;
    letter-spacing:.22em;
    text-transform:uppercase;
    opacity:0;
    pointer-events:none;
    transform:translateX(8px);
    white-space:nowrap;
  }
  .sound-fab:hover .sound-label{
    opacity:.72;
    transform:translateX(0);
  }
  .sound-fab.is-pulse .sound-ico{
    animation: soundPulse 120ms ease-out;
  }
  @keyframes soundPulse{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.08); }
    100%{ transform: scale(1); }
  }

  /* ===== ABOUT overlay ===== */
  .about-overlay{
    position:fixed;
    inset:0;
    z-index:2000;
    display:none;
    pointer-events:none;
  }
  .about-overlay.is-open{
    display:block;
    pointer-events:auto;
  }
  .about-dim{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.50);
  }
  .about-stage{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    padding:min(6vh, 48px) 0;
  }
  .about-shell{
    position:relative;
    width:100vw;
    background:#000;
    overflow:hidden;
  }
  
  /* ===== About actions (CLOSE + Immersive reader) ===== */
  .about-actions{
    position:absolute;
    top:18px;
    right:18px;
    display:flex;
    align-items:center;
    gap:14px;
    z-index:7;
    direction:ltr; /* keep button order consistent even when page is RTL */
  }
.about-close{
    position:static;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    border-radius:999px;
    padding:10px 14px;
    font-size:12px;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(255,255,255,.86);
    cursor:pointer;  }

  /* ===== Immersive reader (ABOUT) — icon-only, no circle ===== */
  .about-tts{
    position:relative;
    width:22px;
    height:22px;
    padding:0;
    border:0;
    background:transparent;
    display:inline-grid;
    place-items:center;
    cursor:pointer;
    color:rgba(255,255,255,.82);
    opacity:.85;
  }
  .about-tts:hover{ opacity:1; }
  .about-tts:focus{ outline:2px solid rgba(255,255,255,.22); outline-offset:6px; border-radius:10px; }

  .about-tts .tts-icon{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    font-size:13px;
    line-height:1;
    transition:opacity 160ms ease;
    opacity:0;
    pointer-events:none;
  }
  .about-tts .tts-reader{ opacity:.95; }

  /* Desktop hover shows play/pause; mobile keeps reader icon */
  @media (hover:hover) and (pointer:fine){
    .about-tts:hover .tts-reader{ opacity:0; }
    .about-tts:hover .tts-play{ opacity:1; }
    .about-tts.is-playing:hover .tts-play{ opacity:0; }
    .about-tts.is-playing:hover .tts-pause{ opacity:1; }
    .about-tts.is-paused:hover .tts-play{ opacity:1; }
  }
  @media (hover:none){
    .about-tts .tts-reader{ opacity:.95; }
  }
  .edge-arrow{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:56px;
    height:120px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    display:grid;
    place-items:center;
    cursor:pointer;
    opacity:0;
    pointer-events:none;
    z-index:7;
    user-select:none;
    -webkit-user-select:none;
  }
  .edge-arrow.left{ left:18px; }
  .edge-arrow.right{ right:18px; }
  .edge-arrow svg{ width:22px; height:22px; opacity:.9; }
  .about-shell.is-hot .edge-arrow{ opacity:.9; pointer-events:auto; }
  .edge-arrow.is-disabled{ opacity:.18 !important; pointer-events:none !important; }

  .about-index{
    position:absolute;
    left:24px;
    bottom:18px;
    font-size:11px;
    letter-spacing:.14em;
    text-transform:uppercase;
    opacity:.55;
    pointer-events:none;
    z-index:6;
  }

  .about-track{
    display:flex;
    overflow:hidden;
    scroll-snap-type:x mandatory;
    scroll-behavior:smooth;
    touch-action: pan-x pinch-zoom;
  }
  .about-panel{
    min-width:100%;
    scroll-snap-align:start;
    padding:56px 0;
    box-sizing:border-box;
  }
  .about-inner{
    width:min(1180px, calc(100vw - 96px));
    margin:0 auto;
  }
  .about-grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:48px;
    align-items:start;
  }
  .about-media{
    height:min(52vh, 520px);
    border-radius:26px;
    overflow:hidden;
    background:#000;
    border:1px solid rgba(255,255,255,.10);
    position:relative;
  }
  .about-media::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(900px 550px at 70% 25%, rgba(255,255,255,.10), transparent 55%),
      radial-gradient(700px 420px at 20% 75%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.70));
    opacity:.95;
  }
  .about-media::after{
    content:"";
    position:absolute; inset:-20%;
    background: radial-gradient(closest-side, rgba(255,255,255,.06), transparent 70%);
    filter: blur(18px);
    opacity:.6;
    transform: translate3d(0,0,0);
  }

  .about-kicker{
    font-size:12px;
    letter-spacing:.18em;
    text-transform:uppercase;
    opacity:.6;
    margin:0 0 14px;
  }
  .about-title{
    margin:0 0 18px;
    font-size:28px;
    line-height:1.15;
    letter-spacing:.06em;
    text-transform:uppercase;
    color:rgba(255,255,255,.92);
  }
  .about-p{
    margin:0 0 18px;
    font-size:14px;
    line-height:1.65;
    opacity:.72;
    max-width:70ch;
  }
  .about-hr{
    height:1px;
    background:rgba(255,255,255,.10);
    margin:22px 0;
  }

  /* Mobile dots (always visible) */
  .about-dots{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    z-index:8;
    display:flex;
    gap:10px;
    opacity:.85;
    pointer-events:auto;
  }
  .dot{
    width:7px;
    height:7px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.35);
    background:transparent;
    cursor:pointer;
  }
  .dot.is-active{
    background:rgba(255,255,255,.70);
    border-color:rgba(255,255,255,.70);
  }
  @media (min-width: 981px){
    .about-dots{ display:none; }
  }

  @media (max-width: 980px){
    .about-inner{ width:min(1180px, calc(100vw - 44px)); }
    .about-grid{ grid-template-columns:1fr; }
    .about-media{ height:44vh; }
    .edge-arrow{ opacity:.92; pointer-events:auto; height:92px; width:52px; }
    .about-shell.is-hot .edge-arrow{ opacity:.92; pointer-events:auto; }
  }

  /* ===== Screen-reader only ===== */
  .sr-only{
    position:absolute;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }

  /* ===== RTL (AR) =====
     Requirement: globe stays on RIGHT (not left), dropdown opens LEFT, order flipped. */
  html[dir="rtl"] .topbar{
    left:auto;
    right:18px;               /* keep topbar on the right */
    flex-direction: row-reverse; /* LANG remains rightmost */
  }
  html[dir="rtl"] .lang-btn svg{ transform: scaleX(-1); }

  html[dir="rtl"] .lang-row{
    left:auto;
    right:100%;
    transform:translateY(-50%) translateX(-14px); /* open left */
    flex-direction: row-reverse; /* visual order reversed */
  }

  html[dir="rtl"] .sound-fab{
    left:auto;
    right:18px;
    flex-direction: row-reverse;
  }
  html[dir="rtl"] .sound-label{
    transform:translateX(-8px);
  }
  html[dir="rtl"] .sound-fab:hover .sound-label{
    transform:translateX(0);
  }

/* ── microstudioX type FX (scramble + i18n fade) ── */
[data-i18n]{
  display:inline-block;
  transition: opacity 160ms ease, transform 160ms ease, filter 160ms ease;
  will-change: opacity, transform, filter;
}
[data-i18n].mx-i18n-out{
  opacity:0;
  transform: translateY(2px);
  filter: blur(1px);
}
[data-i18n].mx-i18n-in{
  opacity:1;
  transform: translateY(0);
  filter: blur(0);
}
@media (prefers-reduced-motion: reduce){
  [data-i18n]{ transition:none !important; }
}

</style>
</head>

<body>
<div class="bg-fallback" aria-hidden="true"></div>

<video id="bg" autoplay muted loop playsinline preload="metadata">
  <source src="CT.mp4" type="video/mp4">
</video>

<!-- ARIA announcer -->
<div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="announcer"></div>

<div class="topbar">
  <!-- LANG FIRST -->
  <div class="lang" id="langWrap" aria-label="Language">
    <div class="lang-btn" id="langBtn" title="Language" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="1.9"/>
        <path d="M2.5 12h19" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
        <path d="M12 2c2.8 2.8 2.8 16.2 0 20" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
        <path d="M12 2c-2.8 2.8-2.8 16.2 0 20" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" opacity=".85"/>
      </svg>
    </div>

    <div class="lang-row" aria-hidden="true">
      <span class="lang-chip" data-lang="en">EN</span>
      <span class="lang-chip" data-lang="es">ES</span>
      <span class="lang-chip" data-lang="ca">CA</span>
      <span class="lang-chip" data-lang="ar">AR</span>
      <span class="lang-chip" data-lang="zh">ZH</span>
      <span class="lang-chip" data-lang="ru">RU</span>
    </div>
  </div>

  <div class="toplink muted" id="aboutBtn" data-i18n="top_about">ABOUT</div>

  <div class="toplink nodes"><span data-i18n="top_nodes">NODES</span>
    <div class="nodes-bridge" aria-hidden="true"></div>
    <div class="nodes-stack" aria-hidden="true">
      <div class="node" data-node="001">001</div>
      <div class="node" data-node="002">002</div>
      <div class="node" data-node="003">003</div>
    </div>
  </div>
</div>

<div class="index-footer" data-i18n="footer_html">
  <a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a>
  · MICROLABSX IS A PROJECT UNDER DEVELOPMENT. NO COMMERCIAL ACTIVITY.
</div>

<!-- ABOUT overlay -->
<div class="about-overlay" id="aboutOverlay" aria-hidden="true">
  <div class="about-dim" id="aboutDim"></div>

  <div class="about-stage">
    <div class="about-shell" id="aboutShell" role="dialog" aria-modal="true" aria-label="About panels">
      <div class="about-actions">

      <!-- IMMERSIVE READER (carousel panels) -->
      <button class="about-tts" id="aboutSpeak" type="button"
        aria-label="Immersive reader"
        aria-pressed="false"
        title="Immersive reader">
        <span class="tts-icon tts-reader" aria-hidden="true">⌁</span>
        <span class="tts-icon tts-play" aria-hidden="true">▶</span>
        <span class="tts-icon tts-pause" aria-hidden="true">⏸</span>
      </button>

      <button class="about-close" id="aboutClose" type="button" data-i18n="ui_close">CLOSE</button>

    </div>

      <span class="sr-only" id="ttsStatus" aria-live="polite" aria-atomic="true"></span>
<div class="edge-arrow left" id="prevBtn" title="Previous">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M14.5 5L8 12l6.5 7" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="edge-arrow right" id="nextBtn" title="Next">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9.5 5L16 12l-6.5 7" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="about-index" id="aboutIndex">01 / 03</div>

      <div class="about-dots" id="aboutDots" aria-label="Pagination">
        <div class="dot is-active" data-dot="0" role="button" tabindex="0" aria-label="Page 1"></div>
        <div class="dot" data-dot="1" role="button" tabindex="0" aria-label="Page 2"></div>
        <div class="dot" data-dot="2" role="button" tabindex="0" aria-label="Page 3"></div>
      </div>

      <div class="about-track" id="aboutTrack">
        <section class="about-panel" data-panel="about">
          <div class="about-inner">
            <div class="about-grid">
              <div class="about-media" aria-hidden="true"></div>
              <div>
                <div class="about-kicker" data-i18n="about_kicker">ABOUT</div>
                <h2 class="about-title" data-i18n="about_title">A GLOBAL, SCALABLE SYSTEM FOR THE NEXT INDUSTRIAL ERA.</h2>

                <p class="about-p" data-i18n="about_p1">
                  Our objective is to provide governments with a globally deployable and scalable solution based on advanced automation and controlled biotechnology infrastructure.
                </p>

                <div class="about-hr"></div>

                <p class="about-p" data-i18n="about_p2">
                  The system is designed to transform physical space into fully automated operational environments,
                  aligned with the emerging industrial paradigm where software, robotics, and data orchestration redefine production.
                </p>

                <p class="about-p" data-i18n="about_p3">
                  By prioritizing automation as a foundational layer, our approach supports efficiency, resilience, and long-term sovereignty across public and institutional deployments.
                </p>
              </div>
            </div>
          </div>
        </section>

        <section class="about-panel" data-panel="ceo">
          <div class="about-inner">
            <div class="about-kicker" data-i18n="ceo_kicker">microlabsX</div>
            <h2 class="about-title" data-i18n="ceo_title">WHO WE ARE</h2>

            <p class="about-p" data-i18n="ceo_p1">
              MicroretailX LLC is the legal entity behind this initiative. We develop automation-first systems for controlled, scalable biotech infrastructure across institutional environments.
            </p>

            <div class="about-hr"></div>

            <p class="about-p" data-i18n="ceo_p2">
              We focus on the structural layer of the next industrial shift: robotics, software orchestration,
              and measurable execution as a deployable operating system for space.
            </p>
          </div>
        </section>

        <section class="about-panel" data-panel="gov">
          <div class="about-inner">
            <div class="about-kicker" data-i18n="gov_kicker">GOVERNMENTS</div>
            <h2 class="about-title" data-i18n="gov_title">INSTITUTIONAL DEPLOYMENT</h2>

            <p class="about-p" data-i18n="gov_p1">
              A globally deployable framework for public-sector and institutional partners:
              pilot environments, regulatory alignment, operational governance, and long-term resilience.
            </p>

            <div class="about-hr"></div>

            <p class="about-p" data-i18n="gov_p2">developing contact</p>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<!-- SOUND FAB -->
<div class="sound-fab" id="soundFab" role="button" tabindex="0" aria-label="Sound toggle">
  <span class="sound-label" id="soundLabel">SOUND OFF</span>

  <svg class="sound-ico sound-on" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M11 5.5L7.8 8H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.8L11 18.5a1 1 0 0 0 1.6-.8V6.3a1 1 0 0 0-1.6-.8Z"
          fill="none" stroke="currentColor" stroke-width="3.0" stroke-linejoin="round"/>
    <path d="M15 9.1c1.15.9 1.15.9 1.15 2.9s0 2-1.15 2.9"
          fill="none" stroke="currentColor" stroke-width="3.0" stroke-linecap="round"/>
    <path d="M17.5 7.2c1.9 1.65 1.9 1.65 1.9 4.8s0 3.15-1.9 4.8"
          fill="none" stroke="currentColor" stroke-width="3.0" stroke-linecap="round" opacity=".92"/>
  </svg>

  <svg class="sound-ico sound-off" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M11 5.5L7.8 8H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.8L11 18.5a1 1 0 0 0 1.6-.8V6.3a1 1 0 0 0-1.6-.8Z"
          fill="none" stroke="currentColor" stroke-width="3.0" stroke-linejoin="round"/>
    <path d="M18.8 7.2L7.2 18.8"
          fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round"/>
  </svg>
</div>

<script>
/* =========================
   Helpers
========================= */
function $(id){ return document.getElementById(id); }

/* =========================
   I18N
========================= */
const SUPPORTED = ["en","es","ca","ar","zh","ru"];
const I18N = {
  en:{ top_about:"ABOUT", top_nodes:"NODES", ui_close:"CLOSE",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX IS A PROJECT UNDER DEVELOPMENT. NO COMMERCIAL ACTIVITY.`,
    about_kicker:"ABOUT", about_title:"A GLOBAL, SCALABLE SYSTEM FOR THE NEXT INDUSTRIAL ERA.",
    about_p1:"Our objective is to provide governments and institutions with a globally deployable and scalable solution based on advanced automation and controlled biotechnology infrastructure, designed to reduce structural dependencies on strategic resources (including protein)",
    about_p2:"The system is designed to transform physical space into fully automated operational environments, aligned with the emerging industrial paradigm where software, robotics, and data orchestration redefine production.",
    about_p3:"By prioritizing automation as a foundational layer, our approach supports efficiency, resilience, and long-term operational capacity across public and institutional deployments.",
    ceo_kicker:"microlabsX", ceo_title:"WHO WE ARE",
    ceo_p1:"MicroretailX LLC is the legal entity behind this initiative. We develop automation-first systems for controlled, scalable biotech infrastructure across institutional environments.",
    ceo_p2:"We focus on the structural layer of the next industrial shift: robotics, software orchestration, and measurable execution as a deployable operating system for space.",
    gov_kicker:"GOVERNMENTS", gov_title:"INSTITUTIONAL DEPLOYMENT",
    gov_p1:"A globally deployable framework for public-sector and institutional partners: pilot environments, regulatory alignment, operational governance, and long-term resilience.",
    gov_p2:"developing contact",
    top_sound_on_off:{on:"SOUND ON",off:"SOUND OFF"}
  },
  es:{ top_about:"INFO", top_nodes:"NODES", ui_close:"CERRAR",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX ES UN PROYECTO EN DESARROLLO. SIN ACTIVIDAD COMERCIAL.`,
    about_kicker:"ABOUT", about_title:"UN SISTEMA GLOBAL Y ESCALABLE PARA LA PRÓXIMA ERA INDUSTRIAL.",
    about_p1:"Nuestro objetivo es ofrecer a gobiernos e instituciones una solución global, desplegable y escalable basada en automatización avanzada e infraestructura biotecnológica controlada, orientada a reducir dependencias estructurales en recursos estratégicos (incluida la proteína)",
    about_p2:"El sistema transforma el espacio físico en entornos operativos totalmente automatizados, alineados con el nuevo paradigma industrial donde el software, la robótica y la orquestación de datos redefinen la producción.",
    about_p3:"Al priorizar la automatización como capa fundacional, nuestro enfoque impulsa eficiencia, resiliencia y soberanía operativa a largo plazo en despliegues públicos e institucionales.",
    ceo_kicker:"microlabsX", ceo_title:"QUIÉNES SOMOS",
    ceo_p1:"MicroretailX LLC es la entidad legal detrás de esta iniciativa. Desarrollamos sistemas con automatización como base para infraestructura biotecnológica controlada y escalable en entornos institucionales.",
    ceo_p2:"Nos centramos en la capa estructural del próximo cambio industrial: robótica, orquestación de software y ejecución medible como sistema operativo desplegable para el espacio.",
    gov_kicker:"GOBIERNOS", gov_title:"DESPLIEGUE INSTITUCIONAL",
    gov_p1:"Un marco globalmente desplegable para socios del sector público e institucional: entornos piloto, alineación regulatoria, gobernanza operativa y resiliencia a largo plazo.",
    gov_p2:"contacto en desarrollo",
    top_sound_on_off:{on:"SONIDO ON",off:"SONIDO OFF"}
  },
  ca:{ top_about:"INFO", top_nodes:"NODES", ui_close:"TANCAR",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX ÉS UN PROJECTE EN DESENVOLUPAMENT. SENSE ACTIVITAT COMERCIAL.`,
    about_kicker:"ABOUT", about_title:"UN SISTEMA GLOBAL I ESCALABLE PER A LA PROPERA ERA INDUSTRIAL.",
    about_p1:"El nostre objectiu és oferir als governs una solució global, desplegable i escalable basada en automatització avançada i infraestructura biotecnològica controlada, orientada a reduir dependències estructurals en recursos estratègics (inclosa la proteïna).",
    about_p2:"El sistema transforma l’espai físic en entorns operatius totalment automatitzats, alineats amb el nou paradigma industrial on el programari, la robòtica i l’orquestració de dades redefineixen la producció.",
    about_p3:"En prioritzar l’automatització com a capa fonamental, el nostre enfocament impulsa eficiència, resiliència i sobirania operativa a llarg termini en desplegaments públics i institucionals.",
    ceo_kicker:"microlabsX", ceo_title:"QUI SOM",
    ceo_p1:"MicroretailX LLC és l’entitat legal darrere d’aquesta iniciativa. Desenvolupem sistemes amb automatització com a base per a infraestructura biotecnològica controlada i escalable en entorns institucionals.",
    ceo_p2:"Ens centrem en la capa estructural del proper canvi industrial: robòtica, orquestració de programari i execució mesurable com a sistema operatiu desplegable per a l’espai.",
    gov_kicker:"GOVERNS", gov_title:"DESPLEGAMENT INSTITUCIONAL",
    gov_p1:"Un marc desplegable globalment per a socis del sector públic i institucional: entorns pilot, alineació regulatòria, governança operativa i resiliència a llarg termini.",
    gov_p2:"contacte en desenvolupament",
    top_sound_on_off:{on:"SO ON",off:"SO OFF"}
  },
  ar:{ top_about:"نبذة", top_nodes:"عُقَد", ui_close:"إغلاق",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX مشروع قيد التطوير. لا نشاط تجاري.`,
    about_kicker:"نبذة", about_title:"نظام عالمي قابل للتوسع لعصر صناعي جديد.",
    about_p1:"نهدف إلى تزويد الحكومات والمؤسسات بحل عالمي قابل للنشر والتوسع، قائم على الأتمتة المتقدمة وبنية تحتية للتقنية الحيوية مُحكَمة، يهدف إلى تقليل الاعتماد الهيكلي على الموارد الاستراتيجية — بما في ذلك البروتين —.",
    about_p2:"يحوّل النظام المساحات الفيزيائية إلى بيئات تشغيل مؤتمتة بالكامل، منسجمة مع التحول الصناعي حيث يعيد البرمجيات والروبوتات وتنسيق البيانات تعريف الإنتاج.",
    about_p3:"من خلال اعتماد الأتمتة كطبقة تأسيسية، يدعم نهجنا الكفاءة والمرونة وبناء قدرات تشغيلية مستدامة طويلة الأمد في البيئات العامة والمؤسسية.",
    ceo_kicker:"microlabsX", ceo_title:"من نحن",
    ceo_p1:"MicroretailX LLC هي الكيان القانوني وراء هذه المبادرة. نطوّر أنظمة «الأتمتة أولاً» لبنية تحتية للتقنية الحيوية محكومة وقابلة للتوسع ضمن بيئات مؤسسية.",
    ceo_p2:"نركّز على الطبقة البنيوية للتحول الصناعي القادم: الروبوتات، تنسيق البرمجيات، والتنفيذ القابل للقياس كنظام تشغيل قابل للنشر للمساحات.",
    gov_kicker:"الحكومات", gov_title:"النشر المؤسسي",
    gov_p1:"إطار عالمي قابل للنشر لشركاء القطاع العام والمؤسسات: بيئات تجريبية، مواءمة تنظيمية، حوكمة تشغيلية، ومرونة طويلة الأمد.",
    gov_p2:"جهة الاتصال قيد التطوير",
    top_sound_on_off:{on:"الصوت تشغيل",off:"الصوت إيقاف"}
  },
  zh:{ top_about:"关于", top_nodes:"节点", ui_close:"关闭",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX 项目开发中。无商业活动。`,
    about_kicker:"关于", about_title:"面向下一代工业时代的全球可扩展系统。",
    about_p1:"我们的目标是为政府和机构提供一种可全球部署、可扩展的解决方案，基于先进自动化与受控的生物技术基础设施，以降低对战略性资源（包括蛋白）的结构性依赖为目标。",
    about_p2:"该系统将物理空间转化为完全自动化的运营环境，契合新兴工业范式：软件、机器人与数据编排正在重塑生产。",
    about_p3:"通过将自动化作为基础层，我们的方法支持效率、韧性以及公共和机构级部署中的长期可持续运营能力。",
    ceo_kicker:"microlabsX", ceo_title:"我们是谁",
    ceo_p1:"MicroretailX LLC 是本项目背后的法律实体。我们为机构环境开发以自动化为先的系统，用于受控、可扩展的生物技术基础设施。",
    ceo_p2:"我们聚焦下一次工业转型的结构层：机器人、软件编排与可量化执行，作为可部署的空间操作系统。",
    gov_kicker:"政府", gov_title:"机构部署",
    gov_p1:"面向公共部门与机构伙伴的全球可部署框架：试点环境、合规对齐、运营治理与长期韧性。",
    gov_p2:"联系方式建设中",
    top_sound_on_off:{on:"声音开",off:"声音关"}
  },
  ru:{ top_about:"О НАС", top_nodes:"УЗЛЫ", ui_close:"ЗАКРЫТЬ",
    footer_html:`<a href="https://www.microretailx.com" target="_blank" rel="noopener">MICRORETAILX LLC</a> · MICROLABSX — ПРОЕКТ В РАЗРАБОТКЕ. БЕЗ КОММЕРЧЕСКОЙ ДЕЯТЕЛЬНОСТИ.`,
    about_kicker:"О НАС", about_title:"ГЛОБАЛЬНАЯ МАСШТАБИРУЕМАЯ СИСТЕМА ДЛЯ НОВОЙ ИНДУСТРИАЛЬНОЙ ЭПОХИ.",
    about_p1:"Наша цель — предоставить правительствам и институциональным партнёрам глобально развёртываемое и масштабируемое решение на основе передовой автоматизации и контролируемой биотехнологической инфраструктуры, направленное на снижение структурной зависимости от стратегических ресурсов, включая белок.",
    about_p2:"Система превращает физическое пространство в полностью автоматизированные операционные среды, соответствующие новому индустриальному сдвигу, где ПО, робототехника и оркестрация данных переопределяют производство.",
    about_p3:"Рассматривая автоматизацию как фундаментальный уровень, наш подход обеспечивает эффективность, устойчивость и формирование долгосрочного операционного потенциала для публичных и институциональных развертываний.",
    ceo_kicker:"microlabsX", ceo_title:"КТО МЫ",
    ceo_p1:"MicroretailX LLC — юридическое лицо, стоящее за этой инициативой. Мы разрабатываем системы «automation-first» для контролируемой и масштабируемой биотехнологической инфраструктуры в институциональных средах.",
    ceo_p2:"Мы фокусируемся на структурном слое следующего индустриального сдвига: робототехника, оркестрация ПО и измеримое исполнение как разворачиваемая операционная система для пространства.",
    gov_kicker:"ГОСУДАРСТВА", gov_title:"ИНСТИТУЦИОНАЛЬНОЕ ВНЕДРЕНИЕ",
    gov_p1:"Глобально разворачиваемый фреймворк для государственного и институционального сектора: пилотные среды, регуляторное соответствие, операционное управление и долгосрочная устойчивость.",
    gov_p2:"контакт в разработке",
    top_sound_on_off:{on:"ЗВУК ВКЛ",off:"ЗВУК ВЫКЛ"}
  }
};

function currentDict(){
  const lang = (localStorage.getItem("mrx_lang") || "en");
  return I18N[lang] || I18N.en;
}

function applyLanguage(lang){
  if (!I18N[lang]) lang = DEFAULT_LANG;
  localStorage.setItem(storageKey, lang);

  const dict = I18N[lang] || I18N[DEFAULT_LANG];

  // dir / lang
  document.documentElement.lang = lang;
  document.documentElement.dir  = RTL_LANGS.has(lang) ? "rtl" : "ltr";

  // reduced motion -> instant swap
  const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Scramble pools (lightweight, no dependencies)
  const POOL_LATIN = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  const POOL_CYR   = "АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЫЭЮЯ0123456789";
  const POOL_DEV   = "अआइईउऊएऐओऔकखगघचछजझटठडढतथदधनपफबभमयरलवशषसह०१२३४५६७८९";
  const POOL_CJK   = "的一是在不了有人这中大为上个国我以要他时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经";
  const POOL_AR    = "ابتثجحخدذرزسشصضطظعغفقكلمنهوي٠١٢٣٤٥٦٧٨٩";

  function poolForLang(l){
    if (l === "ru") return POOL_CYR;
    if (l === "hi") return POOL_DEV;
    if (l === "zh") return POOL_CJK;
    if (l === "ar") return POOL_AR;
    return POOL_LATIN;
  }

  function scrambleTo(el, finalText, durationMs){
    if (!el) return;
    const base = String(finalText ?? "");
    if (reduce){ el.textContent = base; return; }

    const pool = poolForLang(lang);
    const isArabic = (lang === "ar");
    const start = performance.now();

    const tick = (t) => {
      const p = Math.min(1, (t - start) / durationMs);
      const reveal = Math.floor(p * base.length);

      if (isArabic){
        const shown = base.slice(0, reveal);
        const hidden = base.slice(reveal).replace(/[^\s]/g, " ");
        el.textContent = shown + hidden;
        if (p < 1) requestAnimationFrame(tick);
        else el.textContent = base;
        return;
      }

      let out = "";
      for (let i = 0; i < base.length; i++){
        const c = base[i];
        if (i < reveal) { out += c; continue; }
        if (c === " ") { out += " "; continue; }
        if (/[\.\,\!\?\:\;\-\—\–\(\)\[\]\/\&\+%#@€$£"']/.test(c)) { out += c; continue; }
        out += pool[(Math.random() * pool.length) | 0];
      }
      el.textContent = out;

      if (p < 1) requestAnimationFrame(tick);
      else el.textContent = base;
    };

    requestAnimationFrame(tick);
  }

  const nodes = Array.from(document.querySelectorAll("[data-i18n]"));

  // pre-out
  nodes.forEach(el => {
    // Avoid wiping large HTML blocks (footer rich HTML)
    const k = el.getAttribute("data-i18n");
    if (k === "footer_html") return;
    el.classList.add("mx-i18n-out");
  });

  // swap with kinetic type
  setTimeout(() => {
    nodes.forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (!key) return;

      // footer_html is injected as HTML; keep as-is
      if (key === "footer_html"){
        const html = dict[key] ?? I18N[DEFAULT_LANG][key];
        if (typeof html === "string") el.innerHTML = html;
        return;
      }

      const val = dict[key] ?? I18N[DEFAULT_LANG][key];
      if (typeof val !== "string") return;
      scrambleTo(el, val, 220);
      el.classList.remove("mx-i18n-out");
      el.classList.add("mx-i18n-in");
    });

    // cleanup
    setTimeout(() => nodes.forEach(el => el.classList.remove("mx-i18n-in")), 240);
  }, 140);
}

/* =========================
   LANG UI
========================= */
function initLang(){
  const wrap = $("langWrap");
  const btn  = $("langBtn");
  if(!wrap || !btn) return;

  function open(){ wrap.classList.add("is-open"); btn.setAttribute("aria-expanded","true"); }
  function close(){ wrap.classList.remove("is-open"); btn.setAttribute("aria-expanded","false"); }
  function toggle(e){ e.stopPropagation(); wrap.classList.contains("is-open") ? close() : open(); }

  btn.addEventListener("click", toggle);
  btn.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(e); }
  });

  wrap.addEventListener("click", (e)=> e.stopPropagation());
  document.addEventListener("click", close);

  document.querySelectorAll(".lang-chip").forEach(chip=>{
    chip.addEventListener("click", (e)=>{
      e.stopPropagation();
      applyLanguage(chip.getAttribute("data-lang"));
      close();
    });
  });
}

/* =========================
   SOUND (robust)
========================= */
function getSoundRefs(){
  return { v: $("bg"), fab: $("soundFab"), label: $("soundLabel") };
}

function syncSoundUI(){
  const { v, fab, label } = getSoundRefs();
  if(!v || !fab || !label) return;

  const muted = !!v.muted;
  fab.classList.toggle("is-muted", muted);

  const dict = currentDict();
  let txt = muted ? "SOUND OFF" : "SOUND ON";
  if(dict && dict.top_sound_on_off){
    txt = dict.top_sound_on_off[muted ? "off" : "on"] || txt;
  }
  label.textContent = txt;
}

let lastToggleAt = 0;
async function toggleSound(e){
  if(e){ e.stopPropagation(); e.preventDefault(); }
  const now = performance.now();
  if(now - lastToggleAt < 220) return;
  lastToggleAt = now;

  const { v, fab } = getSoundRefs();
  if(!v || !fab) return;

  fab.classList.remove("is-pulse");
  void fab.offsetWidth;
  fab.classList.add("is-pulse");
  setTimeout(()=> fab.classList.remove("is-pulse"), 140);

  v.muted = !v.muted;

  if(!v.muted){
    try{
      v.volume = 1;
      if(v.paused) await v.play();
    }catch(_){
      v.muted = true; // rollback if blocked
    }
  }
  syncSoundUI();
}

function initSound(){
  const { fab } = getSoundRefs();
  if(!fab) return;

  fab.addEventListener("pointerdown", toggleSound, { passive:false });
  fab.addEventListener("click", toggleSound, { passive:false });
  fab.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggleSound(e); }
  });

  syncSoundUI();
}

/* =========================
   ABOUT modal (focus + dots + announcer)
========================= */
function initAbout(){
  const aboutBtn = $("aboutBtn");
  const overlay  = $("aboutOverlay");
  const dim      = $("aboutDim");
  const closeBtn = $("aboutClose");
  const shell    = $("aboutShell");

  const track = $("aboutTrack");
  const panels = track ? Array.from(track.querySelectorAll(".about-panel")) : [];
  const prevBtn = $("prevBtn");
  const nextBtn = $("nextBtn");
  const indexEl = $("aboutIndex");
  const dotsWrap = $("aboutDots");
  const dots = dotsWrap ? Array.from(dotsWrap.querySelectorAll(".dot")) : [];
  const announcer = $("announcer");

  if(!aboutBtn || !overlay || !dim || !closeBtn || !shell || !track) return;

  let lastFocus = null;

  function w(){ return track.clientWidth || window.innerWidth; }
  function idx(){ return Math.round(track.scrollLeft / w()); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  function updateDots(i){
    dots.forEach((d,di)=> d.classList.toggle("is-active", di === i));
  }

  function updateNav(){
    const i = idx();
    if(indexEl) indexEl.textContent = String(i+1).padStart(2,"0") + " / " + String(panels.length).padStart(2,"0");
    if(prevBtn) prevBtn.classList.toggle("is-disabled", i === 0);
    if(nextBtn) nextBtn.classList.toggle("is-disabled", i === panels.length - 1);
    updateDots(i);

    if(announcer){
      const dict = currentDict();
      const label = dict?.about_kicker || "Panel";
      announcer.textContent = `${label} ${i+1} / ${panels.length}`;
      setTimeout(()=> announcer.textContent = "", 900);
    }
  }

  function scrollToIndex(i){
    const target = clamp(i,0,panels.length-1) * w();
    track.scrollTo({ left: target, behavior:"smooth" });
    setTimeout(updateNav, 120);
  }

  function trapFocus(e){
    if(!overlay.classList.contains("is-open")) return;
    if(e.key !== "Tab") return;

    const focusables = overlay.querySelectorAll('button,[role="button"],[tabindex="0"],a[href]');
    const list = Array.from(focusables).filter(el=> !el.classList.contains("is-disabled") && el.offsetParent !== null);
    if(list.length === 0) return;

    const first = list[0];
    const last  = list[list.length - 1];

    if(e.shiftKey && document.activeElement === first){
      e.preventDefault(); last.focus();
    }else if(!e.shiftKey && document.activeElement === last){
      e.preventDefault(); first.focus();
    }
  }

  function openAbout(panelKey){
    lastFocus = document.activeElement;

    overlay.classList.add("is-open");
    overlay.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";

    let i = 0;
    if(panelKey){
      const found = panels.findIndex(p => p.dataset.panel === panelKey);
      i = found >= 0 ? found : 0;
    }
    scrollToIndex(i);
    updateNav();

    setTimeout(()=> closeBtn.focus(), 0);
  }

  function closeAbout(){
    overlay.classList.remove("is-open");
    overlay.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    shell.classList.remove("is-hot");
    if(lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
  }

  aboutBtn.addEventListener("click", ()=> openAbout("about"));
  dim.addEventListener("click", closeAbout);
  closeBtn.addEventListener("click", closeAbout);

  document.addEventListener("keydown", (e)=>{
    if(!overlay.classList.contains("is-open")) return;
    if(e.key === "Escape") closeAbout();
    if(e.key === "ArrowLeft") scrollToIndex(idx() - 1);
    if(e.key === "ArrowRight") scrollToIndex(idx() + 1);
    trapFocus(e);
  });

  if(prevBtn) prevBtn.addEventListener("click", ()=> scrollToIndex(idx() - 1));
  if(nextBtn) nextBtn.addEventListener("click", ()=> scrollToIndex(idx() + 1));
  track.addEventListener("scroll", ()=> updateNav(), { passive:true });

  dots.forEach(d=>{
    const go = ()=> scrollToIndex(parseInt(d.getAttribute("data-dot"),10));
    d.addEventListener("click", go);
    d.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); go(); }});
  });

  let hotT = null;
  function setHot(on){
    shell.classList.toggle("is-hot", on);
    if(on){
      clearTimeout(hotT);
      hotT = setTimeout(()=> shell.classList.remove("is-hot"), 1000);
    }
  }
  shell.addEventListener("mousemove", (e)=>{
    const r = shell.getBoundingClientRect();
    const x = e.clientX - r.left;
    const near = (x < 140) || (x > r.width - 140);
    if(near) setHot(true);
  });
  shell.addEventListener("mouseleave", ()=> shell.classList.remove("is-hot"));

  window.addEventListener("resize", ()=>{ scrollToIndex(idx()); updateNav(); });
  updateNav();
}


/* =========================
   IMMERSIVE READER (TTS) — ABOUT only
========================= */
function ttsLangFromApp(lang){
  switch(lang){
    case "es": return "es-ES";
    case "ca": return "ca-ES";
    case "ar": return "ar-SA";
    case "zh": return "zh-CN";
    case "ru": return "ru-RU";
    default:   return "en-US";
  }
}

function pickVoice(langTag){
  const voices = window.speechSynthesis?.getVoices?.() || [];
  if(!voices.length) return null;
  const primary = String(langTag || "").toLowerCase();
  const base = primary.split("-")[0];
  return (
    voices.find(v => (v.lang||"").toLowerCase() === primary) ||
    voices.find(v => (v.lang||"").toLowerCase().startsWith(base)) ||
    voices.find(v => v.default) ||
    voices[0] ||
    null
  );
}

function buildAboutTextOnly(){
  const track = $("aboutTrack");
  if(!track) return "";

  const panels = Array.from(track.querySelectorAll(".about-panel"));
  if(!panels.length) return "";

  const w = track.clientWidth || window.innerWidth;
  const iRaw = Math.round(track.scrollLeft / w);
  const i = Math.max(0, Math.min(iRaw, panels.length - 1));
  const currentPanel = panels[i];
  if(!currentPanel) return "";

  const kicker = currentPanel.querySelector(".about-kicker")?.textContent?.trim() || "";
  const title = currentPanel.querySelector(".about-title")?.textContent?.trim() || "";
  const paras = Array.from(currentPanel.querySelectorAll(".about-p"))
    .map(p => (p.textContent || "").trim())
    .filter(Boolean);

  return [kicker, title, ...paras].filter(Boolean).join(". ");
}

function initImmersiveTTSAboutOnly(){
  const btn = $("aboutSpeak");
  const overlay = $("aboutOverlay");
  const closeBtn = $("aboutClose");
  const dim = $("aboutDim");
  const status = $("ttsStatus");
  if(!btn || !("speechSynthesis" in window)) return;

  let lastState = "idle"; // idle | playing | paused

  function setState(state){
    lastState = state;
    btn.classList.toggle("is-playing", state === "playing");
    btn.classList.toggle("is-paused", state === "paused");
    btn.setAttribute("aria-pressed", state === "playing" ? "true" : "false");

    if(status){
      status.textContent = state === "playing" ? "Reading." : (state === "paused" ? "Paused." : "Stopped.");
      setTimeout(()=>{ status.textContent = ""; }, 650);
    }
  }

  function stop(){
    try{ window.speechSynthesis.cancel(); }catch(_){}
    setState("idle");
  }

  function speak(){
    const text = buildAboutTextOnly();
    if(!text){ stop(); return; }

    // Cancel any current utterance, then start fresh in current language
    try{ window.speechSynthesis.cancel(); }catch(_){}
    const langTag = ttsLangFromApp(localStorage.getItem("mrx_lang") || "en");

    const u = new SpeechSynthesisUtterance(text);
    u.lang = langTag;

    const voice = pickVoice(langTag);
    if(voice) u.voice = voice;

    u.onend = ()=> setState("idle");
    u.onerror = ()=> setState("idle");

    setState("playing");
    window.speechSynthesis.speak(u);
  }

  function toggle(){
    if(overlay && !overlay.classList.contains("is-open")) return;

    const s = window.speechSynthesis;
    if(s.speaking){
      if(s.paused){
        s.resume();
        setState("playing");
      }else{
        s.pause();
        setState("paused");
      }
      return;
    }
    speak();
  }

  // voices can load async
  window.speechSynthesis.onvoiceschanged = ()=>{};

  btn.addEventListener("click", (e)=>{ e.stopPropagation(); toggle(); });
  btn.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
  });

  // Stop on close
  if(closeBtn) closeBtn.addEventListener("click", stop);
  if(dim) dim.addEventListener("click", stop);
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && overlay?.classList.contains("is-open")) stop();
  });

  // When language changes: if currently reading (or paused), restart in new language
  const _applyLanguage = window.applyLanguage;
  if(typeof _applyLanguage === "function"){
    window.applyLanguage = function(lang){
      _applyLanguage(lang);
      const s = window.speechSynthesis;
      // Only restart if the ABOUT modal is open and user was reading/paused.
      if(overlay?.classList.contains("is-open") && (s.speaking || s.paused || lastState === "paused" || lastState === "playing")){
        speak();
        // If user had paused, pause again after restarting so it doesn't surprise.
        if(lastState === "paused"){
          setTimeout(()=>{ try{ window.speechSynthesis.pause(); setState("paused"); }catch(_){} }, 120);
        }
      }
    };
  }

  setState("idle");
}

/* =========================
   Boot
========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  initLang();
  // Kinetic type hover (Dumbar-style)
  (function(){
    const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduce) return;

    const lastRun = new WeakMap();
    function now(){ return performance.now(); }

    function runFx(el){
      if (!el) return;
      const t = now();
      const prev = lastRun.get(el) || 0;
      if (t - prev < 240) return;
      lastRun.set(el, t);

      const lang = localStorage.getItem(storageKey) || DEFAULT_LANG;
      // reuse applyLanguage's pool logic via a minimal inline (latin default)
      const POOL = (lang==="ru") ? "АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЫЭЮЯ0123456789"
                 : (lang==="hi") ? "अआइईउऊएऐओऔकखगघचछजझटठडढतथदधनपफबभमयरलवशषसह०१२३४५६७८९"
                 : (lang==="zh") ? "的一是在不了有人这中大为上个国我以要他时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经"
                 : (lang==="ar") ? "ابتثجحخدذرزسشصضطظعغفقكلمنهوي٠١٢٣٤٥٦٧٨٩"
                 : "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

      const base = (el.textContent || "");
      const start = performance.now();
      const dur = 260;

      const isArabic = (lang === "ar");
      const tick = (tt) => {
        const p = Math.min(1, (tt - start) / dur);
        const reveal = Math.floor(p * base.length);

        if (isArabic){
          const shown = base.slice(0, reveal);
          const hidden = base.slice(reveal).replace(/[^\s]/g, " ");
          el.textContent = shown + hidden;
          if (p < 1) requestAnimationFrame(tick);
          else el.textContent = base;
          return;
        }

        let out="";
        for (let i=0;i<base.length;i++){
          const c=base[i];
          if (i<reveal) { out+=c; continue; }
          if (c===" ") { out+=" "; continue; }
          if (/[\.\,\!\?\:\;\-\—\–\(\)\[\]\/\&\+%#@€$£"']/.test(c)) { out+=c; continue; }
          out += POOL[(Math.random()*POOL.length)|0];
        }
        el.textContent = out;
        if (p<1) requestAnimationFrame(tick);
        else el.textContent = base;
      };
      requestAnimationFrame(tick);
    }

    const targets = Array.from(document.querySelectorAll("[data-i18n]")).filter(el => el.getAttribute("data-i18n") !== "footer_html");
    targets.forEach(el => {
      el.addEventListener("pointerenter", () => runFx(el));
      el.addEventListener("focus", () => runFx(el));
    });
  })();

  initAbout();
  initSound();
  initImmersiveTTSAboutOnly();

  applyLanguage(localStorage.getItem("mrx_lang") || "en");
});
</script>
</body>
</html>
